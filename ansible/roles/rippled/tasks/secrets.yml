# Secret Management - Split into secret_name (sensitive) and var_secret_name (variable/public)

- name: Fetch node secret
  ansible.builtin.set_fact:
    my_node_secret: "{{ lookup('amazon.aws.secretsmanager_secret', rippled_secret_name, region=ansible_aws_ssm_region, on_denied='skip', on_missing='skip') | default('{}') | from_json }}"
  ignore_errors: true
  no_log: true

- name: Check if secret has valid keys
  ansible.builtin.set_fact:
    secret_has_valid_keys: "{{ (my_node_secret.validation_seed is defined or my_node_secret.node_seed is defined) | bool }}"
  no_log: true

- name: Generate new node keys if secret doesn't have valid keys
  ansible.builtin.shell: |
    su - rippled -s /bin/bash -c '
      # Start rippled temporarily to generate keys
      /opt/ripple/bin/rippled --conf /etc/opt/ripple/rippled.cfg &
      RIPPLED_PID=$!
      sleep 10
      # Generate keys
      OUTPUT=$(/opt/ripple/bin/rippled validation_create 2>/dev/null)
      # Stop rippled
      kill $RIPPLED_PID 2>/dev/null || true
      wait $RIPPLED_PID 2>/dev/null || true
      echo "$OUTPUT"
    '
  register: validation_create_output
  when: not secret_has_valid_keys
  changed_when: true
  no_log: true

- name: Parse generated keys
  ansible.builtin.set_fact:
    generated_keys: "{{ validation_create_output.stdout | from_json }}"
  when: not secret_has_valid_keys
  no_log: true

- name: Create secret (sensitive data) with generated keys
  ansible.builtin.command:
    cmd: >
      aws secretsmanager create-secret
      --region {{ ansible_aws_ssm_region }}
      --name "{{ rippled_secret_name }}"
      --secret-string '{{ generated_keys.result | dict2items | rejectattr("key", "equalto", "validation_public_key") | list | items2dict | to_json }}'
  when: not secret_has_valid_keys
  changed_when: true
  no_log: true

- name: Create var secret (public key) with generated keys
  ansible.builtin.command:
    cmd: >
      aws secretsmanager create-secret
      --region {{ ansible_aws_ssm_region }}
      --name "{{ rippled_var_secret_name }}"
      --secret-string '{{ {"validation_public_key": generated_keys.result.validation_public_key} | to_json }}'
  when: not secret_has_valid_keys
  changed_when: true
  no_log: true

- name: Use generated keys as node secret
  ansible.builtin.set_fact:
    my_node_secret: "{{ generated_keys.result }}"
  when: not secret_has_valid_keys
  no_log: true

- name: Set node_seed from secret
  ansible.builtin.set_fact:
    node_seed: "{{ my_node_secret.validation_seed | default(my_node_secret.node_seed) }}"
  when: my_node_secret.validation_seed is defined or my_node_secret.node_seed is defined
  no_log: true

- name: Set validator_token from secret (validator only)
  ansible.builtin.set_fact:
    validator_token: "{{ my_node_secret.validator_token }}"
  when: my_node_secret.validator_token is defined and my_node_secret.validator_token != ""
  no_log: true
